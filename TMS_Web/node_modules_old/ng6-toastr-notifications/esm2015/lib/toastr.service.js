/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable, ApplicationRef, ComponentFactoryResolver, Injector, ReflectiveInjector, NgZone } from "@angular/core";
import { Subject } from "rxjs";
import { ToastrOptions } from "./toastr.options";
import { Toastr } from "./toastr";
import { ToastrComponent } from "./toastr.component";
/**
 * @record
 * @template T
 */
export function IImplicitContext() { }
function IImplicitContext_tsickle_Closure_declarations() {
    /** @type {?|undefined} */
    IImplicitContext.prototype.$implicit;
}
export class ToastrManager {
    /**
     * @param {?} _applicationRef
     * @param {?} _componentFactoryResolver
     * @param {?} _injector
     * @param {?} ngZone
     * @param {?} options
     */
    constructor(_applicationRef, _componentFactoryResolver, _injector, ngZone, options) {
        this._applicationRef = _applicationRef;
        this._componentFactoryResolver = _componentFactoryResolver;
        this._injector = _injector;
        this.ngZone = ngZone;
        this.options = options;
        this.toastrContainers = [];
        this.index = 0;
        this.toastClicked = new Subject();
    }
    /**
     * @template T
     * @param {?} type
     * @param {?=} providers
     * @return {?}
     */
    createToastrComponent(type, providers = []) {
        // Resolve a factory for creating components of type `type`.
        const /** @type {?} */ factory = this._componentFactoryResolver.resolveComponentFactory(/** @type {?} */ (type));
        // Resolve and create an injector with the specified providers.
        const /** @type {?} */ _providers = ReflectiveInjector.resolve(providers);
        const /** @type {?} */ injector = ReflectiveInjector.fromResolvedProviders(_providers, this._injector);
        // Create new node for inserting into document.
        let /** @type {?} */ newNode = document.createElement("div");
        newNode.id = "toastr-node-" + Math.floor(Math.random() * 200);
        document.querySelector("body").appendChild(newNode);
        // Create a component using the previously resolved factory & injector.
        const /** @type {?} */ componentRef = factory.create(injector, [], newNode);
        // Insert new component node into document body.
        this.attachToApplication(componentRef);
        return componentRef;
    }
    /**
     * @template T
     * @param {?} componentRef
     * @return {?}
     */
    attachToApplication(componentRef) {
        this._applicationRef.attachView(componentRef.hostView);
    }
    /**
     * @template T
     * @param {?} componentRef
     * @return {?}
     */
    detachFromApplication(componentRef) {
        this._applicationRef.detachView(componentRef.hostView);
    }
    /**
     * @param {?} position
     * @return {?}
     */
    isToastrContainerExist(position) {
        if (this.toastrContainers.length > 0) {
            const /** @type {?} */ i = this.toastrContainers.findIndex(x => x.position === position);
            if (i > -1) {
                return true;
            }
        }
        return false;
    }
    /**
     * @param {?} position
     * @return {?}
     */
    getToastrComponentRef(position) {
        if (this.toastrContainers.length > 0) {
            const /** @type {?} */ container = this.toastrContainers.find(x => x.position === position);
            return container ? container.ref : null;
        }
        return null;
    }
    /**
     * @param {?} toast
     * @return {?}
     */
    createTimeout(toast) {
        let /** @type {?} */ task;
        this.ngZone.runOutsideAngular(() => {
            task = setTimeout(() => this.ngZone.run(() => this.clearToast(toast)), toast.config.toastTimeout);
        });
        return task.toString();
    }
    /**
     * @param {?} toast
     * @param {?=} options
     * @return {?}
     */
    setupToast(toast, options) {
        toast.id = ++this.index;
        if (options && options.hasOwnProperty("toastTimeout")) {
            options.dismiss = "auto";
        }
        const /** @type {?} */ customConfig = Object.assign({}, this.options, options || {});
        Object.keys(toast.config).forEach(k => {
            if (customConfig.hasOwnProperty(k)) {
                toast.config[k] = customConfig[k];
            }
        });
        if (toast.config.dismiss === "auto") {
            toast.timeoutId = this.createTimeout(toast);
        }
        toast.toastrManager = this; // bind ToastrManager instance to Toastr
        const /** @type {?} */ position = toast.config.position;
        if (this.isToastrContainerExist(position)) {
            this.getToastrComponentRef(position).instance.addToastr(toast);
        }
        return toast;
    }
    /**
     * @param {?} toast
     * @return {?}
     */
    clearToast(toast) {
        const /** @type {?} */ position = toast.config.position;
        if (this.isToastrContainerExist(position)) {
            let /** @type {?} */ instance = this.getToastrComponentRef(position).instance;
            instance.removeToastr(toast);
        }
    }
    /**
     * @return {?}
     */
    clearAllToasts() {
        if (this.toastrContainers.length > 0) {
            this.toastrContainers.forEach(component => {
                console.log(component);
                const /** @type {?} */ ref = component.ref;
                const /** @type {?} */ instance = component.ref.instance;
                instance.removeAllToasts();
                this.dispose(ref);
            });
        }
    }
    /**
     * @param {?} toastrComponentRef
     * @return {?}
     */
    dispose(toastrComponentRef) {
        if (toastrComponentRef) {
            const /** @type {?} */ i = this.toastrContainers.findIndex(x => x.position === toastrComponentRef.instance.position);
            if (i > -1) {
                this.toastrContainers.splice(i, 1);
            }
            this.detachFromApplication(toastrComponentRef);
        }
    }
    /**
     * @param {?} toast
     * @return {?}
     */
    _onToastClicked(toast) {
        this.toastClicked.next(toast);
        if (toast.config.dismiss !== "controlled") {
            this.clearToast(toast);
        }
    }
    /**
     * @param {?} toast
     * @return {?}
     */
    dismissToastr(toast) {
        this.clearToast(toast);
    }
    /**
     * @return {?}
     */
    dismissAllToastr() {
        this.clearAllToasts();
    }
    /**
     * @return {?}
     */
    onClickToast() {
        return this.toastClicked.asObservable();
    }
    /**
     * @param {?} toastr
     * @param {?=} options
     * @return {?}
     */
    showToastr(toastr, options) {
        const /** @type {?} */ opt = Object.assign({}, this.options, options);
        return new Promise((resolve, reject) => {
            if (!this.isToastrContainerExist(opt.position)) {
                const /** @type {?} */ providers = [{ provide: ToastrOptions, useValue: opt }];
                let /** @type {?} */ toastrComponentRef = this.createToastrComponent(ToastrComponent, providers);
                toastrComponentRef.instance.onToastClicked = (toast) => {
                    this._onToastClicked(toast);
                };
                toastrComponentRef.instance.onExit().subscribe(() => {
                    this.dispose(toastrComponentRef);
                });
                this.toastrContainers.push({
                    position: opt.position,
                    ref: toastrComponentRef
                });
            }
            resolve(this.setupToast(toastr, options));
        });
    }
    /**
     * @param {?} message
     * @param {?=} title
     * @param {?=} options
     * @return {?}
     */
    errorToastr(message, title, options) {
        const /** @type {?} */ data = options && options.data ? options.data : null;
        const /** @type {?} */ toast = new Toastr("error", message, title, data);
        this.showToastr(toast, options);
        return toast;
    }
    /**
     * @param {?} message
     * @param {?=} title
     * @param {?=} options
     * @return {?}
     */
    infoToastr(message, title, options) {
        const /** @type {?} */ data = options && options.data ? options.data : null;
        const /** @type {?} */ toast = new Toastr("info", message, title, data);
        this.showToastr(toast, options);
        return toast;
    }
    /**
     * @param {?} message
     * @param {?=} title
     * @param {?=} options
     * @return {?}
     */
    successToastr(message, title, options) {
        const /** @type {?} */ data = options && options.data ? options.data : null;
        const /** @type {?} */ toast = new Toastr("success", message, title, data);
        this.showToastr(toast, options);
        return toast;
    }
    /**
     * @param {?} message
     * @param {?=} title
     * @param {?=} options
     * @return {?}
     */
    warningToastr(message, title, options) {
        const /** @type {?} */ data = options && options.data ? options.data : null;
        const /** @type {?} */ toast = new Toastr("warning", message, title, data);
        this.showToastr(toast, options);
        return toast;
    }
    /**
     * @param {?} message
     * @param {?=} title
     * @param {?=} options
     * @return {?}
     */
    customToastr(message, title, options) {
        const /** @type {?} */ data = options && options.data ? options.data : null;
        const /** @type {?} */ toast = new Toastr("custom", message, title, data);
        this.showToastr(toast, options);
        return toast;
    }
}
ToastrManager.decorators = [
    { type: Injectable },
];
/** @nocollapse */
ToastrManager.ctorParameters = () => [
    { type: ApplicationRef },
    { type: ComponentFactoryResolver },
    { type: Injector },
    { type: NgZone },
    { type: ToastrOptions }
];
function ToastrManager_tsickle_Closure_declarations() {
    /** @type {?} */
    ToastrManager.prototype.toastrContainers;
    /** @type {?} */
    ToastrManager.prototype.index;
    /** @type {?} */
    ToastrManager.prototype.toastClicked;
    /** @type {?} */
    ToastrManager.prototype._applicationRef;
    /** @type {?} */
    ToastrManager.prototype._componentFactoryResolver;
    /** @type {?} */
    ToastrManager.prototype._injector;
    /** @type {?} */
    ToastrManager.prototype.ngZone;
    /** @type {?} */
    ToastrManager.prototype.options;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9hc3RyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZzYtdG9hc3RyLW5vdGlmaWNhdGlvbnMvIiwic291cmNlcyI6WyJsaWIvdG9hc3RyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFDTCxVQUFVLEVBQ1YsY0FBYyxFQUNkLHdCQUF3QixFQUN4QixRQUFRLEVBRVIsa0JBQWtCLEVBR2xCLE1BQU0sRUFDUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBR2xDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7Ozs7Ozs7OztBQVNyRCxNQUFNOzs7Ozs7OztJQU1KLFlBQ1UsaUJBQ0EsMkJBQ0EsV0FDQSxRQUNBO1FBSkEsb0JBQWUsR0FBZixlQUFlO1FBQ2YsOEJBQXlCLEdBQXpCLHlCQUF5QjtRQUN6QixjQUFTLEdBQVQsU0FBUztRQUNULFdBQU0sR0FBTixNQUFNO1FBQ04sWUFBTyxHQUFQLE9BQU87Z0NBVmMsRUFBRTtxQkFFakIsQ0FBQzs0QkFDdUIsSUFBSSxPQUFPLEVBQVU7S0FRekQ7Ozs7Ozs7SUFHSSxxQkFBcUIsQ0FBSSxJQUFhLEVBQUUsWUFBaUIsRUFBRTs7UUFFakUsdUJBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyx1QkFBdUIsbUJBQUMsSUFBZSxFQUFDLENBQUM7O1FBRXhGLHVCQUFNLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDekQsdUJBQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLHFCQUFxQixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7O1FBRXRGLHFCQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzVDLE9BQU8sQ0FBQyxFQUFFLEdBQUcsY0FBYyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQzlELFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDOztRQUVwRCx1QkFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDOztRQUUzRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkMsTUFBTSxDQUFDLFlBQVksQ0FBQzs7Ozs7OztJQUlkLG1CQUFtQixDQUFJLFlBQTZCO1FBQzFELElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQzs7Ozs7OztJQUlqRCxxQkFBcUIsQ0FBSSxZQUE2QjtRQUM1RCxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7OztJQUdqRCxzQkFBc0IsQ0FBQyxRQUFhO1FBQzFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQyx1QkFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUM7WUFDeEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDWCxNQUFNLENBQUMsSUFBSSxDQUFDO2FBQ2I7U0FDRjtRQUVELE1BQU0sQ0FBQyxLQUFLLENBQUM7Ozs7OztJQUdQLHFCQUFxQixDQUFDLFFBQWE7UUFDekMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLHVCQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQUMsQ0FBQztZQUMzRSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7U0FDekM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDOzs7Ozs7SUFHZCxhQUFhLENBQUMsS0FBYTtRQUN6QixxQkFBSSxJQUFZLENBQUM7UUFDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7WUFDakMsSUFBSSxHQUFHLFVBQVUsQ0FDZixHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQ25ELEtBQUssQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUMxQixDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztLQUN4Qjs7Ozs7O0lBRUQsVUFBVSxDQUFDLEtBQWEsRUFBRSxPQUFhO1FBQ3JDLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXhCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RCxPQUFPLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztTQUMxQjtRQUVELHVCQUFNLFlBQVksR0FBUSxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQztRQUV6RSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDcEMsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25DLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ25DO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNwQyxLQUFLLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDN0M7UUFFRCxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQztRQUUzQix1QkFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFFdkMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxJQUFJLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNoRTtRQUVELE1BQU0sQ0FBQyxLQUFLLENBQUM7S0FDZDs7Ozs7SUFFTyxVQUFVLENBQUMsS0FBYTtRQUM5Qix1QkFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDdkMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxxQkFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQztZQUM3RCxRQUFRLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzlCOzs7OztJQUdLLGNBQWM7UUFDcEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3ZCLHVCQUFNLEdBQUcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDO2dCQUMxQix1QkFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7Z0JBQ3hDLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNuQixDQUFDLENBQUM7U0FDSjs7Ozs7O0lBR0ssT0FBTyxDQUFDLGtCQUFpRDtRQUMvRCxFQUFFLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7WUFDdkIsdUJBQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxLQUFLLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNwRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNYLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3BDO1lBQ0QsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDaEQ7Ozs7OztJQUdLLGVBQWUsQ0FBQyxLQUFhO1FBQ25DLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxLQUFLLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDMUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN4Qjs7Ozs7O0lBR0ksYUFBYSxDQUFDLEtBQWE7UUFDaEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7Ozs7SUFHbEIsZ0JBQWdCO1FBQ3JCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQzs7Ozs7SUFHakIsWUFBWTtRQUNqQixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQzs7Ozs7OztJQUduQyxVQUFVLENBQUMsTUFBYyxFQUFFLE9BQWdCO1FBQ2hELHVCQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXJELE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMvQyx1QkFBTSxTQUFTLEdBQUcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQzlELHFCQUFJLGtCQUFrQixHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FDakQsZUFBZSxFQUNmLFNBQVMsQ0FDVixDQUFDO2dCQUVGLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxjQUFjLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRTtvQkFDN0QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDN0IsQ0FBQztnQkFFRixrQkFBa0IsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtvQkFDbEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2lCQUNsQyxDQUFDLENBQUM7Z0JBRUgsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztvQkFDekIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRO29CQUN0QixHQUFHLEVBQUUsa0JBQWtCO2lCQUN4QixDQUFDLENBQUM7YUFDSjtZQUVELE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzNDLENBQUMsQ0FBQzs7Ozs7Ozs7SUFHRSxXQUFXLENBQUMsT0FBZSxFQUFFLEtBQWMsRUFBRSxPQUFhO1FBQy9ELHVCQUFNLElBQUksR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzNELHVCQUFNLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNoQyxNQUFNLENBQUMsS0FBSyxDQUFDOzs7Ozs7OztJQUdSLFVBQVUsQ0FBQyxPQUFlLEVBQUUsS0FBYyxFQUFFLE9BQWE7UUFDOUQsdUJBQU0sSUFBSSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDM0QsdUJBQU0sS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2hDLE1BQU0sQ0FBQyxLQUFLLENBQUM7Ozs7Ozs7O0lBR1IsYUFBYSxDQUFDLE9BQWUsRUFBRSxLQUFjLEVBQUUsT0FBYTtRQUNqRSx1QkFBTSxJQUFJLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUMzRCx1QkFBTSxLQUFLLEdBQUcsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQzs7Ozs7Ozs7SUFHUixhQUFhLENBQUMsT0FBZSxFQUFFLEtBQWMsRUFBRSxPQUFhO1FBQ2pFLHVCQUFNLElBQUksR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzNELHVCQUFNLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMxRCxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNoQyxNQUFNLENBQUMsS0FBSyxDQUFDOzs7Ozs7OztJQUdSLFlBQVksQ0FBQyxPQUFlLEVBQUUsS0FBYyxFQUFFLE9BQWE7UUFDaEUsdUJBQU0sSUFBSSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDM0QsdUJBQU0sS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2hDLE1BQU0sQ0FBQyxLQUFLLENBQUM7Ozs7WUF2TmhCLFVBQVU7Ozs7WUF4QlQsY0FBYztZQUNkLHdCQUF3QjtZQUN4QixRQUFRO1lBS1IsTUFBTTtZQUtDLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3JlXG5pbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBBcHBsaWNhdGlvblJlZixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBJbmplY3RvcixcbiAgQ29tcG9uZW50UmVmLFxuICBSZWZsZWN0aXZlSW5qZWN0b3IsXG4gIFByb3ZpZGVyLFxuICBUeXBlLFxuICBOZ1pvbmVcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tIFwicnhqc1wiO1xuXG4vLyBDb25maWdcbmltcG9ydCB7IFRvYXN0ck9wdGlvbnMgfSBmcm9tIFwiLi90b2FzdHIub3B0aW9uc1wiO1xuaW1wb3J0IHsgVG9hc3RyIH0gZnJvbSBcIi4vdG9hc3RyXCI7XG5cbi8vIENvbXBvbmVudFxuaW1wb3J0IHsgVG9hc3RyQ29tcG9uZW50IH0gZnJvbSBcIi4vdG9hc3RyLmNvbXBvbmVudFwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIElJbXBsaWNpdENvbnRleHQ8VD4ge1xuICAkaW1wbGljaXQ/OiBUO1xufVxuXG5kZWNsYXJlIHZhciBkb2N1bWVudDtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRvYXN0ck1hbmFnZXIge1xuICB0b2FzdHJDb250YWluZXJzOiBBcnJheTxhbnk+ID0gW107XG5cbiAgcHJpdmF0ZSBpbmRleCA9IDA7XG4gIHByaXZhdGUgdG9hc3RDbGlja2VkOiBTdWJqZWN0PFRvYXN0cj4gPSBuZXcgU3ViamVjdDxUb2FzdHI+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfYXBwbGljYXRpb25SZWY6IEFwcGxpY2F0aW9uUmVmLFxuICAgIHByaXZhdGUgX2NvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgX2luamVjdG9yOiBJbmplY3RvcixcbiAgICBwcml2YXRlIG5nWm9uZTogTmdab25lLFxuICAgIHByaXZhdGUgb3B0aW9uczogVG9hc3RyT3B0aW9uc1xuICApIHt9XG5cbiAgLy8gQ3JlYXRlIFRvYXN0ciBDb21wb25lbnRcbiAgcHJpdmF0ZSBjcmVhdGVUb2FzdHJDb21wb25lbnQ8VD4odHlwZTogVHlwZTxUPiwgcHJvdmlkZXJzOiBhbnkgPSBbXSk6IENvbXBvbmVudFJlZjxUPiB7XG4gICAgLy8gUmVzb2x2ZSBhIGZhY3RvcnkgZm9yIGNyZWF0aW5nIGNvbXBvbmVudHMgb2YgdHlwZSBgdHlwZWAuXG4gICAgY29uc3QgZmFjdG9yeSA9IHRoaXMuX2NvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeSh0eXBlIGFzIFR5cGU8VD4pO1xuICAgIC8vIFJlc29sdmUgYW5kIGNyZWF0ZSBhbiBpbmplY3RvciB3aXRoIHRoZSBzcGVjaWZpZWQgcHJvdmlkZXJzLlxuICAgIGNvbnN0IF9wcm92aWRlcnMgPSBSZWZsZWN0aXZlSW5qZWN0b3IucmVzb2x2ZShwcm92aWRlcnMpO1xuICAgIGNvbnN0IGluamVjdG9yID0gUmVmbGVjdGl2ZUluamVjdG9yLmZyb21SZXNvbHZlZFByb3ZpZGVycyhfcHJvdmlkZXJzLCB0aGlzLl9pbmplY3Rvcik7XG4gICAgLy8gQ3JlYXRlIG5ldyBub2RlIGZvciBpbnNlcnRpbmcgaW50byBkb2N1bWVudC5cbiAgICBsZXQgbmV3Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgbmV3Tm9kZS5pZCA9IFwidG9hc3RyLW5vZGUtXCIgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyMDApO1xuICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJib2R5XCIpLmFwcGVuZENoaWxkKG5ld05vZGUpO1xuICAgIC8vIENyZWF0ZSBhIGNvbXBvbmVudCB1c2luZyB0aGUgcHJldmlvdXNseSByZXNvbHZlZCBmYWN0b3J5ICYgaW5qZWN0b3IuXG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gZmFjdG9yeS5jcmVhdGUoaW5qZWN0b3IsIFtdLCBuZXdOb2RlKTtcbiAgICAvLyBJbnNlcnQgbmV3IGNvbXBvbmVudCBub2RlIGludG8gZG9jdW1lbnQgYm9keS5cbiAgICB0aGlzLmF0dGFjaFRvQXBwbGljYXRpb24oY29tcG9uZW50UmVmKTtcbiAgICByZXR1cm4gY29tcG9uZW50UmVmO1xuICB9XG5cbiAgLy8gSW5zZXJ0cyB0aGUgY29tcG9uZW50IGluIHRoZSByb290IGFwcGxpY2F0aW9uIG5vZGUuXG4gIHByaXZhdGUgYXR0YWNoVG9BcHBsaWNhdGlvbjxUPihjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxUPik6IHZvaWQge1xuICAgIHRoaXMuX2FwcGxpY2F0aW9uUmVmLmF0dGFjaFZpZXcoY29tcG9uZW50UmVmLmhvc3RWaWV3KTtcbiAgfVxuXG4gIC8vIERldGFjaGVzIHRoZSBjb21wb25lbnQgZnJvbSB0aGUgcm9vdCBhcHBsaWNhdGlvbiBub2RlLlxuICBwcml2YXRlIGRldGFjaEZyb21BcHBsaWNhdGlvbjxUPihjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxUPik6IHZvaWQge1xuICAgIHRoaXMuX2FwcGxpY2F0aW9uUmVmLmRldGFjaFZpZXcoY29tcG9uZW50UmVmLmhvc3RWaWV3KTtcbiAgfVxuXG4gIHByaXZhdGUgaXNUb2FzdHJDb250YWluZXJFeGlzdChwb3NpdGlvbjogYW55KSB7XG4gICAgaWYgKHRoaXMudG9hc3RyQ29udGFpbmVycy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBpID0gdGhpcy50b2FzdHJDb250YWluZXJzLmZpbmRJbmRleCh4ID0+IHgucG9zaXRpb24gPT09IHBvc2l0aW9uKTtcbiAgICAgIGlmIChpID4gLTEpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUb2FzdHJDb21wb25lbnRSZWYocG9zaXRpb246IGFueSkge1xuICAgIGlmICh0aGlzLnRvYXN0ckNvbnRhaW5lcnMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy50b2FzdHJDb250YWluZXJzLmZpbmQoeCA9PiB4LnBvc2l0aW9uID09PSBwb3NpdGlvbik7XG4gICAgICByZXR1cm4gY29udGFpbmVyID8gY29udGFpbmVyLnJlZiA6IG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjcmVhdGVUaW1lb3V0KHRvYXN0OiBUb2FzdHIpOiBhbnkge1xuICAgIGxldCB0YXNrOiBudW1iZXI7XG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGFzayA9IHNldFRpbWVvdXQoXG4gICAgICAgICgpID0+IHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLmNsZWFyVG9hc3QodG9hc3QpKSxcbiAgICAgICAgdG9hc3QuY29uZmlnLnRvYXN0VGltZW91dFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB0YXNrLnRvU3RyaW5nKCk7XG4gIH1cblxuICBzZXR1cFRvYXN0KHRvYXN0OiBUb2FzdHIsIG9wdGlvbnM/OiBhbnkpOiBUb2FzdHIge1xuICAgIHRvYXN0LmlkID0gKyt0aGlzLmluZGV4O1xuXG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShcInRvYXN0VGltZW91dFwiKSkge1xuICAgICAgb3B0aW9ucy5kaXNtaXNzID0gXCJhdXRvXCI7XG4gICAgfVxuXG4gICAgY29uc3QgY3VzdG9tQ29uZmlnOiBhbnkgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgfHwge30pO1xuXG4gICAgT2JqZWN0LmtleXModG9hc3QuY29uZmlnKS5mb3JFYWNoKGsgPT4ge1xuICAgICAgaWYgKGN1c3RvbUNvbmZpZy5oYXNPd25Qcm9wZXJ0eShrKSkge1xuICAgICAgICB0b2FzdC5jb25maWdba10gPSBjdXN0b21Db25maWdba107XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAodG9hc3QuY29uZmlnLmRpc21pc3MgPT09IFwiYXV0b1wiKSB7XG4gICAgICB0b2FzdC50aW1lb3V0SWQgPSB0aGlzLmNyZWF0ZVRpbWVvdXQodG9hc3QpO1xuICAgIH1cblxuICAgIHRvYXN0LnRvYXN0ck1hbmFnZXIgPSB0aGlzOyAvLyBiaW5kIFRvYXN0ck1hbmFnZXIgaW5zdGFuY2UgdG8gVG9hc3RyXG5cbiAgICBjb25zdCBwb3NpdGlvbiA9IHRvYXN0LmNvbmZpZy5wb3NpdGlvbjtcblxuICAgIGlmICh0aGlzLmlzVG9hc3RyQ29udGFpbmVyRXhpc3QocG9zaXRpb24pKSB7XG4gICAgICB0aGlzLmdldFRvYXN0ckNvbXBvbmVudFJlZihwb3NpdGlvbikuaW5zdGFuY2UuYWRkVG9hc3RyKHRvYXN0KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cblxuICBwcml2YXRlIGNsZWFyVG9hc3QodG9hc3Q6IFRvYXN0cikge1xuICAgIGNvbnN0IHBvc2l0aW9uID0gdG9hc3QuY29uZmlnLnBvc2l0aW9uO1xuICAgIGlmICh0aGlzLmlzVG9hc3RyQ29udGFpbmVyRXhpc3QocG9zaXRpb24pKSB7XG4gICAgICBsZXQgaW5zdGFuY2UgPSB0aGlzLmdldFRvYXN0ckNvbXBvbmVudFJlZihwb3NpdGlvbikuaW5zdGFuY2U7XG4gICAgICBpbnN0YW5jZS5yZW1vdmVUb2FzdHIodG9hc3QpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2xlYXJBbGxUb2FzdHMoKSB7XG4gICAgaWYgKHRoaXMudG9hc3RyQ29udGFpbmVycy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnRvYXN0ckNvbnRhaW5lcnMuZm9yRWFjaChjb21wb25lbnQgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhjb21wb25lbnQpO1xuICAgICAgICBjb25zdCByZWYgPSBjb21wb25lbnQucmVmO1xuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGNvbXBvbmVudC5yZWYuaW5zdGFuY2U7XG4gICAgICAgIGluc3RhbmNlLnJlbW92ZUFsbFRvYXN0cygpO1xuICAgICAgICB0aGlzLmRpc3Bvc2UocmVmKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGlzcG9zZSh0b2FzdHJDb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxUb2FzdHJDb21wb25lbnQ+KSB7XG4gICAgaWYgKHRvYXN0ckNvbXBvbmVudFJlZikge1xuICAgICAgY29uc3QgaSA9IHRoaXMudG9hc3RyQ29udGFpbmVycy5maW5kSW5kZXgoeCA9PiB4LnBvc2l0aW9uID09PSB0b2FzdHJDb21wb25lbnRSZWYuaW5zdGFuY2UucG9zaXRpb24pO1xuICAgICAgaWYgKGkgPiAtMSkge1xuICAgICAgICB0aGlzLnRvYXN0ckNvbnRhaW5lcnMuc3BsaWNlKGksIDEpO1xuICAgICAgfVxuICAgICAgdGhpcy5kZXRhY2hGcm9tQXBwbGljYXRpb24odG9hc3RyQ29tcG9uZW50UmVmKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9vblRvYXN0Q2xpY2tlZCh0b2FzdDogVG9hc3RyKSB7XG4gICAgdGhpcy50b2FzdENsaWNrZWQubmV4dCh0b2FzdCk7XG4gICAgaWYgKHRvYXN0LmNvbmZpZy5kaXNtaXNzICE9PSBcImNvbnRyb2xsZWRcIikge1xuICAgICAgdGhpcy5jbGVhclRvYXN0KHRvYXN0KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGlzbWlzc1RvYXN0cih0b2FzdDogVG9hc3RyKSB7XG4gICAgdGhpcy5jbGVhclRvYXN0KHRvYXN0KTtcbiAgfVxuXG4gIHB1YmxpYyBkaXNtaXNzQWxsVG9hc3RyKCkge1xuICAgIHRoaXMuY2xlYXJBbGxUb2FzdHMoKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkNsaWNrVG9hc3QoKTogT2JzZXJ2YWJsZTxUb2FzdHI+IHtcbiAgICByZXR1cm4gdGhpcy50b2FzdENsaWNrZWQuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBwdWJsaWMgc2hvd1RvYXN0cih0b2FzdHI6IFRvYXN0ciwgb3B0aW9ucz86IE9iamVjdCk6IFByb21pc2U8VG9hc3RyPiB7XG4gICAgY29uc3Qgb3B0ID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAoIXRoaXMuaXNUb2FzdHJDb250YWluZXJFeGlzdChvcHQucG9zaXRpb24pKSB7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVycyA9IFt7IHByb3ZpZGU6IFRvYXN0ck9wdGlvbnMsIHVzZVZhbHVlOiBvcHQgfV07XG4gICAgICAgIGxldCB0b2FzdHJDb21wb25lbnRSZWYgPSB0aGlzLmNyZWF0ZVRvYXN0ckNvbXBvbmVudDxUb2FzdHJDb21wb25lbnQ+KFxuICAgICAgICAgIFRvYXN0ckNvbXBvbmVudCxcbiAgICAgICAgICBwcm92aWRlcnNcbiAgICAgICAgKTtcblxuICAgICAgICB0b2FzdHJDb21wb25lbnRSZWYuaW5zdGFuY2Uub25Ub2FzdENsaWNrZWQgPSAodG9hc3Q6IFRvYXN0cikgPT4ge1xuICAgICAgICAgIHRoaXMuX29uVG9hc3RDbGlja2VkKHRvYXN0KTtcbiAgICAgICAgfTtcblxuICAgICAgICB0b2FzdHJDb21wb25lbnRSZWYuaW5zdGFuY2Uub25FeGl0KCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmRpc3Bvc2UodG9hc3RyQ29tcG9uZW50UmVmKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy50b2FzdHJDb250YWluZXJzLnB1c2goe1xuICAgICAgICAgIHBvc2l0aW9uOiBvcHQucG9zaXRpb24sXG4gICAgICAgICAgcmVmOiB0b2FzdHJDb21wb25lbnRSZWZcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlc29sdmUodGhpcy5zZXR1cFRvYXN0KHRvYXN0ciwgb3B0aW9ucykpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGVycm9yVG9hc3RyKG1lc3NhZ2U6IHN0cmluZywgdGl0bGU/OiBzdHJpbmcsIG9wdGlvbnM/OiBhbnkpOiBUb2FzdHIge1xuICAgIGNvbnN0IGRhdGEgPSBvcHRpb25zICYmIG9wdGlvbnMuZGF0YSA/IG9wdGlvbnMuZGF0YSA6IG51bGw7XG4gICAgY29uc3QgdG9hc3QgPSBuZXcgVG9hc3RyKFwiZXJyb3JcIiwgbWVzc2FnZSwgdGl0bGUsIGRhdGEpO1xuICAgIHRoaXMuc2hvd1RvYXN0cih0b2FzdCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgcHVibGljIGluZm9Ub2FzdHIobWVzc2FnZTogc3RyaW5nLCB0aXRsZT86IHN0cmluZywgb3B0aW9ucz86IGFueSk6IFRvYXN0ciB7XG4gICAgY29uc3QgZGF0YSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5kYXRhID8gb3B0aW9ucy5kYXRhIDogbnVsbDtcbiAgICBjb25zdCB0b2FzdCA9IG5ldyBUb2FzdHIoXCJpbmZvXCIsIG1lc3NhZ2UsIHRpdGxlLCBkYXRhKTtcbiAgICB0aGlzLnNob3dUb2FzdHIodG9hc3QsIG9wdGlvbnMpO1xuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIHB1YmxpYyBzdWNjZXNzVG9hc3RyKG1lc3NhZ2U6IHN0cmluZywgdGl0bGU/OiBzdHJpbmcsIG9wdGlvbnM/OiBhbnkpOiBUb2FzdHIge1xuICAgIGNvbnN0IGRhdGEgPSBvcHRpb25zICYmIG9wdGlvbnMuZGF0YSA/IG9wdGlvbnMuZGF0YSA6IG51bGw7XG4gICAgY29uc3QgdG9hc3QgPSBuZXcgVG9hc3RyKFwic3VjY2Vzc1wiLCBtZXNzYWdlLCB0aXRsZSwgZGF0YSk7XG4gICAgdGhpcy5zaG93VG9hc3RyKHRvYXN0LCBvcHRpb25zKTtcbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cblxuICBwdWJsaWMgd2FybmluZ1RvYXN0cihtZXNzYWdlOiBzdHJpbmcsIHRpdGxlPzogc3RyaW5nLCBvcHRpb25zPzogYW55KTogVG9hc3RyIHtcbiAgICBjb25zdCBkYXRhID0gb3B0aW9ucyAmJiBvcHRpb25zLmRhdGEgPyBvcHRpb25zLmRhdGEgOiBudWxsO1xuICAgIGNvbnN0IHRvYXN0ID0gbmV3IFRvYXN0cihcIndhcm5pbmdcIiwgbWVzc2FnZSwgdGl0bGUsIGRhdGEpO1xuICAgIHRoaXMuc2hvd1RvYXN0cih0b2FzdCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgcHVibGljIGN1c3RvbVRvYXN0cihtZXNzYWdlOiBzdHJpbmcsIHRpdGxlPzogc3RyaW5nLCBvcHRpb25zPzogYW55KTogVG9hc3RyIHtcbiAgICBjb25zdCBkYXRhID0gb3B0aW9ucyAmJiBvcHRpb25zLmRhdGEgPyBvcHRpb25zLmRhdGEgOiBudWxsO1xuICAgIGNvbnN0IHRvYXN0ID0gbmV3IFRvYXN0cihcImN1c3RvbVwiLCBtZXNzYWdlLCB0aXRsZSwgZGF0YSk7XG4gICAgdGhpcy5zaG93VG9hc3RyKHRvYXN0LCBvcHRpb25zKTtcbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cbn1cbiJdfQ==